# Миграции базы данных

## Обзор

Система миграций автоматически обновляет схему базы данных при запуске приложения. Миграции выполняются только один раз и отслеживаются в таблице `migrations`.

## Как это работает

1. **При первом запуске**: Создаются базовые таблицы с простыми типами `TIMESTAMP`
2. **Автоматически**: Запускаются миграции, которые обновляют схему до нужного состояния
3. **Безопасно**: Каждая миграция выполняется в транзакции и может быть откачена

## Существующие миграции

### Миграция 1: Обновление временных полей на московский часовой пояс

**Описание**: Обновляет поля `created_at` и `updated_at` для использования московского времени

**Изменения**:
- `message_log.created_at` → `TIMESTAMP WITH TIME ZONE` с московским временем
- `message_log.updated_at` → `TIMESTAMP WITH TIME ZONE` с московским временем  
- `training_log.created_at` → `TIMESTAMP WITH TIME ZONE` с московским временем
- `training_log.updated_at` → `TIMESTAMP WITH TIME ZONE` с московским временем

## Ручной запуск миграций

Если нужно запустить миграции вручную:

```bash
# Запуск миграций
make migrate

# Или напрямую
go run ./cmd/migrate
```

## Добавление новых миграций

1. Создайте новую миграцию в `internal/database/migrations.go`:

```go
{
    Version:     2, // Следующий номер версии
    Description: "Описание изменений",
    UpSQL:       `SQL для применения изменений`,
    DownSQL:     `SQL для отката изменений`,
}
```

2. Добавьте миграцию в массив `Migrations`

3. Перезапустите приложение - миграция выполнится автоматически

## Откат миграций

В текущей версии откат миграций не реализован автоматически. Для отката нужно:

1. Выполнить SQL из поля `DownSQL` вручную
2. Удалить запись из таблицы `migrations`

## Мониторинг

Проверить статус миграций можно через SQL:

```sql
SELECT * FROM migrations ORDER BY version;
```

## Безопасность

- Все миграции выполняются в транзакциях
- При ошибке миграция автоматически откатывается
- Каждая миграция выполняется только один раз
- Миграции выполняются в порядке версий
